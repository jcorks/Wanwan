var Wanwan={};Wanwan.Canvas={},Wanwan.Init=function(a,b){},Wanwan.Name=function(a){},Wanwan.Channel=function(a){},Wanwan.Post=function(a){},Wanwan.Canvas.SoftUpdate=function(){},Wanwan.Canvas.Font="monospace",Wanwan.Canvas.FontSize="13pt",Wanwan.Canvas.FullUpdate=function(){},Wanwan.Init=function(a,b){Wanwan.Canvas.Element=document.getElementById(a),Wanwan.Canvas.Context=Wanwan.Canvas.Element.getContext("2d"),Wanwan.Server.URL=b,Wanwan.Name("Potato"),Wanwan.Channel("Lobby"),setInterval(Wanwan.Server.Check,300)},Wanwan.Name=function(a){Wanwan.Client.userName=a},Wanwan.Channel=function(a){Wanwan.Client.channelName!=a&&Wanwan.Canvas.ClearText(),Wanwan.Client.channelName=a},Wanwan.Post=function(a){Wanwan.Client.Post(a)},Wanwan.Canvas.SoftUpdate=function(){null!=Wanwan.Canvas.Context&&Wanwan.Canvas.Update()},Wanwan.Canvas.FullUpdate=function(){null!=Wanwan.Canvas.Context&&Wanwan.Canvas.UpdateFramebuffer()},Wanwan.Canvas.Text=[],Wanwan.Canvas.Animation={},Wanwan.Canvas.Animation.Enter=[],Wanwan.Canvas.Properties={},Wanwan.Canvas.Offscreen=document.createElement("canvas"),Wanwan.Canvas.Animation.Enter.default=function(a,b){return!0},Wanwan.Canvas.AddMessage=function(a,b,c,d){var e={};e.speaker=a,e.content=b,e.color=c,e.onEnter=Wanwan.Canvas.Animation.Enter[d],e.enterFinished=!1,e.persist={},null==e.onEnter&&(e.onEnter=Wanwan.Canvas.Animation.Enter.default),Wanwan.Canvas.Text.push(e),requestAnimationFrame(Wanwan.Canvas.UpdateFramebuffer)},Wanwan.Canvas.UpdateFramebuffer=function(){var a=!1,b=Wanwan.Canvas.Offscreen.getContext("2d");Wanwan.Canvas.Offscreen.height=Wanwan.Canvas.Element.height,Wanwan.Canvas.Offscreen.width=Wanwan.Canvas.Element.width;var c=""+Wanwan.Canvas.FontSize+" "+Wanwan.Canvas.Font;Wanwan.Canvas.Properties.FontWidth||(Wanwan.Canvas.Properties.FontWidth=b.measureText("M").width),b.setTransform(1,0,0,1,0,0);var d=Math.floor(Wanwan.Canvas.Offscreen.height/(1.5*parseInt(Wanwan.Canvas.FontSize)));b.clearRect(0,0,Wanwan.Canvas.Offscreen.width,Wanwan.Canvas.Offscreen.height);for(var e=0;e<d&&e<Wanwan.Canvas.Text.length;++e){if(Wanwan.Canvas.Text.length>d)var f=Wanwan.Canvas.Text[e+Wanwan.Canvas.Text.length-d];else var f=Wanwan.Canvas.Text[e];b.translate(0,Math.floor(1.5*parseInt(Wanwan.Canvas.FontSize))),b.font=c,b.textAlign="left",b.fillStyle=f.color,b.fillText(f.speaker+": ",0,0),b.translate(12*Wanwan.Canvas.Properties.FontWidth,0),f.enterFinished?(b.fillColor=f.color,b.fillText(f.content,0,0)):(f.enterFinished=f.onEnter(f,b),a=!0),b.translate(12*-Wanwan.Canvas.Properties.FontWidth,0)}a&&null==Wanwan.Canvas.UpdateID&&(Wanwan.Canvas.UpdateID=setTimeout(function(){requestAnimationFrame(Wanwan.Canvas.UpdateFramebuffer),Wanwan.Canvas.UpdateID=null},15)),Wanwan.Canvas.Update()},Wanwan.Canvas.Update=function(){Wanwan.Canvas.Context.clearRect(0,0,Wanwan.Canvas.Element.width,Wanwan.Canvas.Element.height),Wanwan.Canvas.Context.drawImage(Wanwan.Canvas.Offscreen,0,0,Wanwan.Canvas.Offscreen.width,Wanwan.Canvas.Offscreen.height,0,0,Wanwan.Canvas.Element.width,Wanwan.Canvas.Element.height)},Wanwan.Canvas.ClearText=function(){Wanwan.Canvas.Text=[],Wanwan.Client.index=0},Wanwan.Client={},Wanwan.Client.index=0,Wanwan.Client.ScriptController={},Wanwan.Client.SendRequest=function(a,b){var c=Wanwan.Client.ScriptController[b];null!=c&&document.body.removeChild(c),c=document.createElement("script"),c.id="WANWAN_js_request",c.setAttribute("type","text/javascript"),c.setAttribute("src",Wanwan.Server.URL+"?"+a),c.setAttribute("async","async");var d=document.body;d.appendChild(c),Wanwan.Client.ScriptController[b]=c},Wanwan.Client.Post=function(a){var b="Core.Speech";if(a.length>=4&&"["==a[0]&&"]"==a[2]){switch(a[1]){case"~":b="Core.Wavey";break;case"!":b="Core.Shock"}a=a.substring(3,a.length)}var c=[];c.push("WANWANPOST"),c.push(Wanwan.Client.userName),c.push(a),c.push(b),c.push(Wanwan.Client.channelName);var d=Wanwan.Server.Hexify(c);Wanwan.Client.SendRequest(d,"Post"),clearTimeout(Wanwan.Server.NeedsUpdateID),Wanwan.Server.NeedsUpdateID=null},Wanwan.Client.RequestUpdate=function(){var a=[];a.push("WANWANUPDT"),a.push(Wanwan.Client.channelName),a.push(Wanwan.Client.index.toString());var b=Wanwan.Server.Hexify(a);Wanwan.Client.SendRequest(b,"Update")},Wanwan.Server={},Wanwan.Server.URL="",Wanwan.Server.Messages=[],Wanwan.Server.NeedsUpdateID=null,Wanwan.Server.Check=function(){if(null==Wanwan.Server.NeedsUpdateID&&(Wanwan.Client.RequestUpdate(),Wanwan.Server.NeedsUpdateID=setTimeout(function(){Wanwan.Server.NeedsUpdateID=null},7e3)),Wanwan.Server.Messages.length){for(var a=0;a<Wanwan.Server.Messages.length;++a){var b=Wanwan.Server.Dehexify(Wanwan.Server.Messages[a]);switch(b[0]){case"WANWANMSG":if(6!=b.length)continue;if(Wanwan.Client.index>=parseInt(b[5]))continue;Wanwan.Canvas.AddMessage(b[1],b[2],b[3],Wanwan.Server.Messages.length>8?"Default":b[4]),Wanwan.Client.index=parseInt(b[5])}}Wanwan.Server.Messages=[],clearTimeout(Wanwan.Server.NeedsUpdateID),Wanwan.Server.NeedsUpdateID=null}},Wanwan.Server.HexLookup=[];for(var i=0;i<103;++i)Wanwan.Server.HexLookup.push(0);Wanwan.Server.HexLookup[48]=0,Wanwan.Server.HexLookup[49]=1,Wanwan.Server.HexLookup[50]=2,Wanwan.Server.HexLookup[51]=3,Wanwan.Server.HexLookup[52]=4,Wanwan.Server.HexLookup[53]=5,Wanwan.Server.HexLookup[54]=6,Wanwan.Server.HexLookup[55]=7,Wanwan.Server.HexLookup[56]=8,Wanwan.Server.HexLookup[57]=9,Wanwan.Server.HexLookup[97]=10,Wanwan.Server.HexLookup[98]=11,Wanwan.Server.HexLookup[99]=12,Wanwan.Server.HexLookup[100]=13,Wanwan.Server.HexLookup[101]=14,Wanwan.Server.HexLookup[102]=15,Wanwan.Server.HexToUint8=function(a){return 16*Wanwan.Server.HexLookup[a.charCodeAt(0)]+Wanwan.Server.HexLookup[a.charCodeAt(1)]},Wanwan.Server.Dehexify=function(a){for(var c,e,b=[],f=0;f<a.length;f+=2){if(c="",e=Wanwan.Server.HexToUint8(a.substring(f,f+2)),0!=e)return[];for(f+=2,e=Wanwan.Server.HexToUint8(a.substring(f,f+2));0!=e&&f<a.length;)c+=String.fromCharCode(e),f+=2,e=Wanwan.Server.HexToUint8(a.substring(f,f+2));if(0!=e)return[];b.push(c)}return b},Wanwan.Server.ReverseHexLookup=[],Wanwan.Server.ReverseHexLookup[0]="0",Wanwan.Server.ReverseHexLookup[1]="1",Wanwan.Server.ReverseHexLookup[2]="2",Wanwan.Server.ReverseHexLookup[3]="3",Wanwan.Server.ReverseHexLookup[4]="4",Wanwan.Server.ReverseHexLookup[5]="5",Wanwan.Server.ReverseHexLookup[6]="6",Wanwan.Server.ReverseHexLookup[7]="7",Wanwan.Server.ReverseHexLookup[8]="8",Wanwan.Server.ReverseHexLookup[9]="9",Wanwan.Server.ReverseHexLookup[10]="a",Wanwan.Server.ReverseHexLookup[11]="b",Wanwan.Server.ReverseHexLookup[12]="c",Wanwan.Server.ReverseHexLookup[13]="d",Wanwan.Server.ReverseHexLookup[14]="e",Wanwan.Server.ReverseHexLookup[15]="f",Wanwan.Server.Uint8ToHex=function(a){return a>255&&(a=255),Wanwan.Server.ReverseHexLookup[Math.floor(a/16)]+Wanwan.Server.ReverseHexLookup[a%16]},Wanwan.Server.Hexify=function(a){for(var b="",c=0;c<a.length;++c){b+="00";for(var d=0;d<a[c].length;++d)b+=Wanwan.Server.Uint8ToHex(a[c].charCodeAt(d));b+="00"}return b},Wanwan.Canvas.Animation.Enter["Core.Wavey"]=function(a,b){if(null==a.persist.counter){a.persist.counter=0,a.persist.factor=1,a.persist.locTable=[],a.persist.locTable.push(0);for(var c=1;c<a.content.length;++c)a.persist.locTable.push(b.measureText(a.content.substring(0,c)).width);a.persist.timeoutID=null}b.fillColor=a.color;for(var e,d=a.persist.counter,c=0;c<a.content.length;++c)e=a.content.substring(c,c+1),b.fillText(e,a.persist.locTable[c],Math.floor(a.persist.factor*Math.sin(d/7)*8)),d+=5;return null==a.persist.timeoutID&&(a.persist.timeoutID=setTimeout(function(){a.persist.factor*=.87,a.persist.counter+=4,a.persist.timeoutID=null},15)),a.persist.factor<.006},Wanwan.Canvas.Animation.Enter["Core.Speech"]=function(a,b){if(null==a.persist.index&&(a.persist.index=0,a.persist.wait=0,a.persist.updateID=null,a.persist.fn=function(){a.persist.index++,a.persist.updateID=null}),b.fillColor=a.color,b.fillText(a.content.substring(0,a.persist.index)+"â–¡",0,0),null==a.persist.updateID){var c=a.content.substring(a.persist.index,a.persist.index+1);"."==c||"?"==c||"!"==c?a.persist.updateID=setTimeout(a.persist.fn,160):","==c?a.persist.updateID=setTimeout(a.persist.fn,70):a.persist.updateID=setTimeout(a.persist.fn,20+(Math.random()>.9?90:0))}return a.persist.index>=a.content.length},Wanwan.Canvas.Animation.Enter["Core.Shock"]=function(a,b){if(null==a.persist.factor){a.persist.factor=1,a.persist.locTable=[],a.persist.locTable.push(0);for(var c=1;c<a.content.length;++c)a.persist.locTable.push(b.measureText(a.content.substring(0,c)).width);a.persist.timeoutID=null}b.fillColor=a.color;for(var d,c=0;c<a.content.length;++c)d=a.content.substring(c,c+1),b.fillText(d,a.persist.locTable[c]+10*(Math.random()-.5)*a.persist.factor,10*+(Math.random()-.5)*a.persist.factor);return null==a.persist.timeoutID&&(a.persist.timeoutID=setTimeout(function(){a.persist.factor*=.95,a.persist.timeoutID=null},15)),a.persist.factor<.006};
